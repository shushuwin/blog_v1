import { useEffect, useRef, useState } from 'react'
import { motion } from 'framer-motion'
import { Shield } from 'lucide-react'
import { api } from '@/services/api'

export default function MalwareScan() {
  const [file, setFile] = useState<File | null>(null)
  const [result, setResult] = useState<{ label: string; confidence: number; ensemble_score?: number } | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [progress, setProgress] = useState(0)
  const [eta, setEta] = useState<string>('—')
  const timerRef = useRef<number | null>(null)

  function estimateTime(sizeBytes: number) {
    const mb = sizeBytes / (1024 * 1024)
    const base = 2 // base seconds
    const perMb = 0.1 // seconds per MB
    const est = Math.min(30, Math.max(base, base + mb * perMb))
    return `${Math.round(est)}s`
  }

  function startProgress(sizeBytes: number) {
    setProgress(0)
    setEta(estimateTime(sizeBytes))
    if (timerRef.current) window.clearInterval(timerRef.current)
    const total = 100
    const estSec = parseInt(estimateTime(sizeBytes)) || 10
    const stepMs = (estSec * 1000) / total
    timerRef.current = window.setInterval(() => {
      setProgress(p => {
        const next = Math.min(95, p + 1)
        return next
      })
    }, Math.max(50, stepMs))
  }

  function stopProgress() {
    if (timerRef.current) {
      window.clearInterval(timerRef.current)
      timerRef.current = null
    }
    setProgress(100)
    setEta('完成')
  }

  async function scan() {
    setError('')
    setResult(null)
    if (!file) return
    const form = new FormData()
    form.append('file', file)
    setLoading(true)
    startProgress(file.size)
    try {
      const r = await api.post('/api/files/scan', form, { timeout: 60000 })
      setResult(r.data)
    } catch (e: any) {
      setError(e.response?.data?.detail || '扫描失败')
    } finally {
      setLoading(false)
      stopProgress()
    }
  }

  useEffect(() => () => { if (timerRef.current) window.clearInterval(timerRef.current) }, [])

  return (
    <div className="min-h-screen py-16 px-6">
      <div className="max-w-3xl mx-auto">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.6 }} className="mb-8">
          <h1 className="text-4xl font-light text-stone-900 mb-2">恶意软件检测</h1>
          <p className="text-stone-600">上传样本进行静态推断（演示用途）</p>
        </motion.div>

        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center gap-3 mb-4">
            <Shield className="w-6 h-6 text-stone-700" />
            <span className="text-stone-700">选择待检测文件</span>
          </div>
          <input type="file" className="border border-stone-300 px-3 py-2 rounded bg-white text-stone-900" onChange={e => setFile(e.target.files?.[0] || null)} />
          <button onClick={scan} disabled={!file || loading} className="mt-4 px-4 py-2 bg-stone-900 text-white rounded hover:bg-stone-800 transition-colors">
            {loading ? '正在扫描...' : '开始扫描'}
          </button>
          {loading && (
            <div className="mt-4">
              <div className="flex items-center justify-between text-xs text-stone-600 mb-1">
                <span>预估时间：{eta}</span>
                <span>{progress}%</span>
              </div>
              <div className="h-2 bg-stone-200 rounded">
                <div className="h-2 bg-stone-900 rounded" style={{ width: `${progress}%` }}></div>
              </div>
            </div>
          )}
          {error && <div className="mt-4 text-red-600 text-sm">{error}</div>}
          {result && (
            <div className="mt-6">
              <div className="text-stone-900 mb-2">检测结果</div>
              <div className="grid grid-cols-2 gap-2 text-sm">
                <div className="text-stone-600">文件名</div>
                <div className="text-stone-900">{file?.name || '—'}</div>
                <div className="text-stone-600">预测</div>
                <div className="text-stone-900">{result.label}</div>
                <div className="text-stone-600">置信度</div>
                <div className="text-stone-900">{(result.confidence * 100).toFixed(2)}%</div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}